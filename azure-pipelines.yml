
trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'windows-latest'

variables:
  buildConfiguration: 'Release'
  dotnetVersion: '8.0.x'
  projectPath: 'ClientLibrary/Samples/ClientSamples.netcore.csproj'
  artifactName: 'drop'
  appName: 'my-dotnet-appservice'
  azureSubscription: 'azure-appservice-conn'

stages:
- stage: Build
  displayName: Build Stage
  jobs:
  - job: BuildJob
    steps:

    # Step 1: Install .NET SDK
    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: $(dotnetVersion)

    # Step 2: Restore
    - script: dotnet restore $(projectPath)
      displayName: 'Restore NuGet packages'

    # Step 3: Build
    - script: dotnet build $(projectPath) --configuration $(buildConfiguration)
      displayName: 'Build application'

    # Step 4: Publish
    - script: dotnet publish $(projectPath) \
        --configuration $(buildConfiguration) \
        --output $(Build.ArtifactStagingDirectory)
      displayName: 'Publish application'

    # Step 5: Publish Artifact
    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: $(artifactName)

---

- stage: Deploy
  displayName: Deploy Stage
  dependsOn: Build
  jobs:
  - job: DeployJob
    steps:

    # Step 6: Download Artifact
    - task: DownloadBuildArtifacts@0
      inputs:
        artifactName: $(artifactName)
        downloadPath: $(System.DefaultWorkingDirectory)

    # Step 7: Deploy to Azure App Service
    - task: AzureWebApp@1
      inputs:
        azureSubscription: $(azureSubscription)
        appName: $(appName)
        package: '$(System.DefaultWorkingDirectory)/$(artifactName)'
cdf-uopd-tbw